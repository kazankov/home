<?require_once $_SERVER['DOCUMENT_ROOT'].'/modules/command.php';require_once $_SERVER['DOCUMENT_ROOT'].'/modules/media.php';function tmpFileName($ext){  $folder = $_SERVER['DOCUMENT_ROOT'].'/tmp/';  do {     $file = $folder.rand(1,99999).time().'.'.$ext;   } while (file_exists($file));  return $file;}/*** Медиа*/class Media{	/**	*  получить файл по идентификатору	*  в ответе на запрос следует использовать url	*/	function get($id)	{		global $db;		return fixMongoId($db->media->findOne(array('_id' => new MongoId($id))));	}	/**	*	добавить 	* filename - имя файла (пример test.pdf) <br>	* title - заголовок <br>	* content - содержимое файла	*/	function put($filename, $title, $content=FILE_CONSTANT)	{		global $db;				$ext = mb_strtolower(pathinfo($filename, PATHINFO_EXTENSION));		$ps = PresentationSource::factoryExt($ext);		if(!$ps) error('Не удалось определить тип медиа');				$tmp_file = tmpFileName($ext);		file_put_contents($tmp_file, $content);		$url = $ps->upload($tmp_file, $title, $filename, null);		unlink($tmp_file);				if(!$url) error('Не удалось загрузить медиа');				$obj = 	array(			'url'=>$url,			'ext'=>$ext		);				if(!$db->media->insert($obj))error('Ошибка записи в базу');		return fixMongoId($obj);	}			/**	*	редактировать 	*/	function post($id, $title, $content=FILE_CONSTANT)	{		global $db;		if(!$id)error('Идентификатор  не указан');				$obj = $db->media->findOne(array('_id' => new MongoId($id)));			if(!$obj) error('Запись с таким id не существует');				$ps = PresentationSource::factoryExt($obj['ext']);		if(!$ps) error('Не удалось определить тип медиа');				if(!$ps->delete($obj['url'])) error('Не удалось удалить медиа');				$tmp_file =  tmpFileName($obj['ext']);		file_put_contents($tmp_file, $content);		$url = $ps->upload($tmp_file, $title, basename($tmp_file), null);				unlink($tmp_file);				if(!$url) error('Не удалось загрузить медиа');				$obj['url'] = $url;				if(!$db->media->update(array('_id' => new MongoId($id)), $obj)) error('Ошибка записи в базу');		return fixMongoId($obj);	}			/**	*	удалить 	*/	function delete($id)	{		global $db;				$obj = $db->media->findOne(array('_id' => new MongoId($id)));			if(!$obj) error('Запись с таким id не существует');				$ps = PresentationSource::factoryExt($obj['ext']);		if(!$ps) error('Не удалось определить тип медиа');				if(!$ps->delete($obj['url'])) error('Не удалось удалить медиа');								$buf = $db->media->remove(array('_id' => new MongoId($id)), array("justOne" => true, 'safe'=>true));		$res = !!$buf['ok'];				return $res;	}	}?>