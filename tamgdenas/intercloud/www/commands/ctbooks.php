<?require_once $_SERVER['DOCUMENT_ROOT'].'/modules/command.php';/*** Список ситибуков*/class Ctbooks{	/**	*	Получить список ситибуков<br>	*	author - url автора	*	bounds - прямоугольная гео-область, две пары координат широта/долгота: юг/запад, север/восток (пример - [[55.667662,37.690487],[55.7025,37.769451]] ) <br>	*   locaion - центр сортировки, ближайшие будут выводиться в начале (пример - {"lat":55.7023996,"lon":37.6936055} )	*/		function get($author, $bounds, $location)	{		global $db;		$params = array();		if($author) $params['author']=normUrl($author);				$cursor = $db->ctbooks->find($params, array('_id'=>true, 'title'=>true, 'pois'=>true));			if(!$bounds && !$location) return fixMongoId(iterator_to_array($cursor, false));				$out = array();		$bounds = json_decode($bounds);		foreach($cursor as $iter)		{			if($iter['pois']) 			{				foreach($iter['pois'] as $poiId)				{					$poi = null;					if($bounds) //если есть границы, надо проверить входит либо в них хотя бы одно poi					{						$poi = $db->poi->findOne(array('_id' => new MongoId($poiId), 'geoPoint'=>array('$within'=>array('$box'=> $bounds))));						if(!$poi) continue;					}else{						$poi = $db->poi->findOne(array('_id' => new MongoId($poiId))); //когда границ нет, берем первое попавшееся					}					if($location) //если есть центр сортировки, сортируем ситибуки используя poi					{						$l = json_decode($location, true);						$p = $poi['geoPoint'];						$r = sqrt(sqr(($l['lat']-$p['lat'])/2) + sqr(($l['lon']-$p['lon'])/2));						$key = $r.'_'.$iter['_id'];						$out[$key] = $iter;					}else{						$out[] = $iter;					}					break;				}			}else{				if(!$bounds && $location) $out['9999999999999999_'.$iter['_id']] = $iter; //ситибуке без poi попадает в конец списка сортировки			}		}		if($location)		{			ksort($out);			$out = array_values($out);		}				return fixMongoId($out);	}	/**	*	Удалить все ситибуки	*/		function delete()	{		global $db;		$buf = $db->ctbooks->remove(array(), array('safe'=>true));		return !!$buf['ok'];		}}?>